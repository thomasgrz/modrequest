import{g as l,l as o,s as g}from"./subscribeToRuleChanges-DxDFSGwk.js";const y=async()=>{const r=await l(),s=await chrome.declarativeNetRequest.getDynamicRules(),d=s.map(e=>e.id),c=r.filter(e=>!d.includes(e.details.id)),a=async e=>{try{await chrome.declarativeNetRequest.updateDynamicRules({addRules:[e]})}catch(i){o("Failed to sync dynamic rules",i);const h=new RegExp(/Rule\swith\sid\s(.\d+)/).exec(i.message),u=Number(h?.[1]);if(!u)return;const p=(await l()).map(n=>n.details.id===u?{...n,meta:{...n.meta,error:i.message}}:n);await chrome.storage.local.set({rules:p})}};await Promise.allSettled(c.map(e=>e.details).map(async e=>a(e)));const t=r.map(e=>e.details.id),m=s.filter(e=>!t.includes(e.id)),w=r.filter(e=>!e.meta.enabledByUser),R=[...m.map(e=>e.id),...w.map(e=>e.details.id)];await chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:R})};o("service worker installed",{});chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}).catch(r=>console.error(r));chrome.runtime.onInstalled.addListener(()=>{chrome.contextMenus.create({id:"openSidePanel",title:"Open Interpolate",contexts:["all"]}),o("installed",null),g(()=>{o("updated from background.ts",{}),y()})});chrome.contextMenus.onClicked.addListener((r,s)=>{r.menuItemId==="openSidePanel"&&s?.windowId&&chrome.sidePanel.open({windowId:s?.windowId})});chrome.webRequest.onBeforeRedirect.addListener(async r=>{const s=r?.redirectUrl,a=(await l()).map(t=>({id:t?.details?.id,redirectUrl:t?.details?.action?.redirect?.url})).find(t=>t.redirectUrl&&s.startsWith(t.redirectUrl));a&&chrome.runtime.sendMessage(`redirect-${a.id}-hit`)},{urls:["<all_urls>"]});
